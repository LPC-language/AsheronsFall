/*
 * Derived from public domain ISAAC random number generator source code
 * by Robert Jenkins.
 */

private int *mem;			/* internal state */
private int *rand0, *rand1, *rand2;	/* pseudorandom results */
private int offset;			/* offset in result arrays */
private int seedA, seedB, seedC;	/* seed, initially all the same */

/*
 * produce a new series of 256 pseudo-random integers
 */
private void isaac()
{
    int i, x, y;

    rand0 = allocate_int(256);
    seedB += ++seedC;
    for (i = 0; i < 256; i++) {
	x = mem[i];
	switch (i & 0x03) {
	case 0:
	    seedA ^= seedA << 13;
	    break;

	case 1:
	    seedA ^= (seedA & 0xffffffff) >> 6;
	    break;

	case 2:
	    seedA ^= seedA << 2;
	    break;

	case 3:
	    seedA ^= (seedA & 0xffffffff) >> 16;
	    break;
	}

	seedA += mem[(i + 128) & 0xff];

	mem[i] = y = mem[(x >> 2) & 0xff] + seedA + seedB;
	rand0[i] = seedB = (mem[(y >> 10) & 0xff] + x) & 0xffffffff;
    }
}

/*
 * initialize ISAAC random number generator
 */
static void create(int seed)
{
    /*
     * AC's way always produces the same initial table
     */
    mem = ({
	0xdb792195, 0xe63bf923, 0x4f6f076d, 0x122cded5, 0xda711220, 0x4f6fcee6,
	0x45e45c44, 0xcf852932, 0x469adbf6, 0x5e12481f, 0x682d2354, 0xbdd21105,
	0x5bb5f3e6, 0x6e8c82ca, 0xd0fdd8e3, 0xbe4cb2df, 0xe3eb3f01, 0xd03d3f32,
	0x77a4e3ff, 0xdf17d4b5, 0x2ac710ac, 0x5acac8ed, 0x703bd8e4, 0x1d9c3b3b,
	0x4564a5d2, 0xb0224742, 0xb5a3048a, 0xa35a3f55, 0xca33744f, 0xf1aec0a0,
	0x0bf4b1a4, 0x04038654, 0x7c65a9ec, 0xaa41dc51, 0xe5096687, 0x1d433c75,
	0x35de20af, 0xdb75da77, 0x230a8e81, 0x18be6b31, 0x8d8857ba, 0x0ec016a2,
	0x2ff6fb27, 0x37d3eb09, 0x91a6a259, 0x13e0ea7b, 0x07926a43, 0x21df97f9,
	0x24fd4beb, 0x10315aa3, 0x58d70df3, 0x7c56f52d, 0x1abf4e8f, 0x50e140b0,
	0xe1e9feb2, 0x90380a5e, 0xea3761d3, 0x583b843b, 0xf0f9496f, 0xc9fcd225,
	0x35ec4846, 0x550cfa8b, 0x574dd012, 0x66c3abf9, 0x55a7dbf8, 0x510a4dae,
	0xff1738cc, 0x9ac85d2f, 0x3a7704f5, 0xddb85a5c, 0x86a50929, 0xfb01bd4f,
	0x877ddf76, 0x187ef004, 0x912e5b3e, 0xebe1cbdd, 0x354f0206, 0x9d889d03,
	0x910d16ef, 0xa67178a7, 0xc2deeedf, 0xe433a4bc, 0x474b91f7, 0x14a28299,
	0xcbad7d66, 0x494d39df, 0x8b6bb28e, 0xcdcc33ee, 0xaf37c9d3, 0x9d79794f,
	0x6b2c05ed, 0xa8823f18, 0x6225d7ed, 0x292e7345, 0xa04ce9df, 0x951abe7f,
	0x72c3cc98, 0xcd1e0582, 0x41224c23, 0x90d26e39, 0xc75b1461, 0xe0b5dbd1,
	0x83ba4f78, 0x2a072f2b, 0xa1a24f28, 0xb3bf06c8, 0xd5335518, 0x186662ac,
	0xbc71c21f, 0x2bfc24a8, 0xdbb15f07, 0x076c83f5, 0xbd656129, 0x507a23d6,
	0xb3ce5930, 0xd68e24ef, 0xe82caf40, 0xa53c0493, 0x79ce3bb7, 0x030fef29,
	0x347e8a30, 0xff6e9d5c, 0xce9b9a04, 0xbc4e5140, 0x949bbe83, 0xcb8b3dbe,
	0xae1d5f44, 0x21148102, 0x754e9eaf, 0xf2deae15, 0xf2eb3a8c, 0x8b1614ae,
	0x6ed005b6, 0xca16dd83, 0x29bd701b, 0xaa6201c9, 0x58ce4025, 0x9c6121cb,
	0x11c03985, 0xeffc2a2a, 0x4136605b, 0x7f30ddfd, 0x19eccc35, 0x4d6e1426,
	0x6360ee03, 0xe69cb55a, 0xd181a69d, 0x7e69a4c7, 0x91b4c97c, 0x9ba0f967,
	0xe05438a6, 0xf6a6ab45, 0xd0808096, 0xce1db289, 0x8fdf796f, 0x4d3b9b25,
	0xa4ad9ae6, 0x5df9105f, 0x71b1fd3e, 0xf90a6f7c, 0xee1d1310, 0x183b6922,
	0x2ad9a280, 0x50ead939, 0x0b5990f6, 0xeab6d31c, 0xd1f23104, 0x3fa68196,
	0xa228dccc, 0x68c10912, 0x9003cf9c, 0xb92e58c4, 0x9fbba10f, 0x3da05555,
	0xae52996d, 0x8f0a3b2c, 0x12f8d4df, 0x02df25c9, 0x51d99d11, 0x950aead2,
	0xfff87b29, 0xcda6b1e7, 0x13056dc7, 0x189ba81a, 0xa23c22e1, 0x0f9e5e7f,
	0x799b23cd, 0x53db90f6, 0xa388548b, 0xb9c0d3e5, 0x753bb810, 0xc3768efd,
	0x2d66b7f2, 0x16eec5cb, 0x4490d722, 0xf813e0e6, 0xd02dc104, 0x1fe5ca4f,
	0x18a27e69, 0x191699ff, 0xb366a330, 0x4b01495d, 0x5529ad4d, 0x48f2fe87,
	0x926c55f1, 0x53491f9b, 0x875ba8d1, 0xef2c3cd8, 0xe50c89f9, 0x5201768c,
	0x1a5c4b35, 0x114c0c76, 0x77d8b1df, 0x75e77e8a, 0x39826ba2, 0x3ffacc4f,
	0xf5ff4ff7, 0xa0b10525, 0xfd46ed4f, 0xe97c9f45, 0x568cb141, 0xd45c1365,
	0x788b2b7e, 0xabaa5158, 0x73ad6aea, 0x041e5fca, 0x0be48855, 0x01c285af,
	0x0b2efb29, 0x49655aee, 0xabbf0b3c, 0x958e4617, 0x0a8cd37a, 0x871758f9,
	0x0db1a84d, 0xe453974a, 0x78308bd6, 0x7456a7eb, 0x76ff0f79, 0x3c1957d9,
	0xd6e89ee6, 0x4db3a5b2, 0xbac849ba, 0xc68e2110, 0xe8f9f2eb, 0x970f676e,
	0x034377b6, 0xf0dc724f, 0xff290056, 0xd3b7f2ff, 0x72df023b, 0x3021aca2,
	0x352ee316, 0xe046b5ca, 0xe94e08bc, 0x41bffb5a
    });
    seedA = seedB = seedC = seed;
    offset = -256;
}

/*
 * Maintain a sequence of up to 768 indexed pseudo-random numbers.  As the
 * index increases, update the pseudo-random number table.
 */
int rand(int index)
{
    if (index < offset) {
	if (index < offset - 512) {
	    error("Out of range");	/* too far back */
	}
	return (index < offset - 256) ?
		rand2[offset - 257 - index] : rand1[offset - 1 - index];
    } else {
	if (index >= offset + 256) {
	    if (index >= offset + 512) {
		error("Out of range");	/* too far ahead */
	    }
	    rand2 = rand1;
	    rand1 = rand0;
	    isaac();
	    offset += 256;
	}
	return rand0[offset + 255 - index];
    }
}
